name: Build and Publish Cluster Management

on:
  release:
    types: [published]
  workflow_dispatch:  # Manual trigger
  push:
    branches:
      - 'feat/fallback-helm-*'
      - 'main'

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  id-token: write

jobs:
  build_container:
    name: Build and Push Docker Image
    uses: truefoundry/workflows/.github/workflows/build.yml@main
    with:
      image_tag: ${{ github.sha }}
      enable_ecr_auth: true
      extra_image_tag: ${{ github.ref_name }}
      depot_project_id: ${{ vars.DEPOT_PROJECT_ID }}
      image_artifact_name: ${{ github.event.repository.name }}
      artifactory_registry_url: ${{ vars.TRUEFOUNDRY_ARTIFACTORY_REGISTRY_URL }}
      artifactory_repository_url: ${{ vars.TRUEFOUNDRY_ARTIFACTORY_PRIVATE_REPOSITORY }}
    secrets:
      depot_token: ${{ secrets.DEPOT_API_KEY }}
      artifactory_username: ${{ secrets.TRUEFOUNDRY_ARTIFACTORY_PRIVATE_USERNAME }}
      artifactory_password: ${{ secrets.TRUEFOUNDRY_ARTIFACTORY_PRIVATE_PASSWORD }}
      ecr_iam_role_arn: ${{ secrets.AWS_DEVTEST_ECR_IAM_ROLE_ARN }}
